{% extends 'layout_panel.html' %}
{% load static %}

{% block title %}Consultar Clientes - ZuluAris CRM{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Consultar Polizas</h2>
    </div>

    <!-- üîç Buscador -->
    <form class="consulta-filtros" method="get" action="">
            <div class="grupo-busqueda">
                <input 
                    type="text" 
                    name="q" 
                    value="{{ query }}" 
                    placeholder="Buscar por nombre o DNI..."
                    class="input-busqueda"
                >

                <select name="producto" class="input-select">
                    <option value="">Producto</option>
                    {% for producto in productos %}
                        <option value="{{ producto.id }}" {% if producto.id|stringformat:"s" == request.GET.producto %}selected{% endif %}>
                            {{ producto.descripcion }}
                        </option>
                    {% endfor %}
                </select>

                <button type="submit" class="btn-buscar">Buscar</button>
                    <a href="{% url 'gestionar_clientes' %}" class="btn-limpiar">Limpiar filtro</a>

            </div>
        </form>

    <!-- Tabla de resultados -->
    <table>
        <thead>
            <tr>
                <th>DNI</th>
                <th>Cliente</th>
                <th>Correo</th>
                <th>Producto</th>
                <th>Vigencia</th>
            </tr>
        </thead>
        <tbody>
            {% if datos_clientes %}
                {% for item in datos_clientes %}
                    {% for poliza in item.polizas %}
                    <tr>
                        <td>{{ item.cliente.dni }}</td>
                        <td>
                            <a href="{% url 'detalle_cliente' item.cliente.dni %}" class="cliente-link">
                                {{ item.cliente.nombre }}
                            </a>
                        </td>
                        <td>{{ item.cliente.correo|default:"-" }}</td>
                        
                        <!-- Producto -->
                        <td>
                            <a href="{% url 'detalle_poliza' poliza.id %}" class="cliente-link">
                                {{ poliza.id_producto.descripcion }}
                            </a>
                        </td>

                        <!-- Vigencia -->
                        <td>
                            {{ poliza.fecha_inicio }} ‚Üí {{ poliza.fecha_fin }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td>{{ item.cliente.dni }}</td>
                        <td>
                            <a href="{% url 'detalle_cliente' item.cliente.dni %}" class="cliente-link">
                                {{ item.cliente.nombre }}
                            </a>
                        </td>
                        <td>{{ item.cliente.correo|default:"-" }}</td>
                        <td>-</td>
                        <td>Sin p√≥liza</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" style="text-align:center;">No hay clientes registrados.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>


    <div class="acciones-polizas">
        <a href="{% url 'crear_poliza' %}" class="btn-guardar">Nueva p√≥liza</a>
    </div>
    
</div>

{% endblock %}